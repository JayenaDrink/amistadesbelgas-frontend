<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amistades Belgas — Admin v3 (fix orden llegada)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-600:#16a34a;--shadow:0 10px 25px rgba(0,0,0,.25);--radius:18px;--green-row:rgba(34,197,94,.12)}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    .container{max-width:1000px;margin:28px auto 56px;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{font-size:22px;margin:0} .muted{color:var(--muted);font-size:12px}
    .toolbar{display:grid;grid-template-columns: 1fr 260px 220px;gap:10px;align-items:end;margin:8px 0}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,button{padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    button{cursor:pointer} .btn-primary{background:var(--accent);border-color:var(--accent-600);color:#052e16;font-weight:700}
    details{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:8px 12px;margin-bottom:8px}
    summary{display:flex;justify-content:space-between;align-items:center;cursor:pointer;list-style:none}
    summary::-webkit-details-marker{display:none}
    .row{display:grid;grid-template-columns: 1fr 120px 110px 110px;gap:6px;align-items:center}
    .status{font-size:12px;border:1px solid #334155;border-radius:999px;padding:2px 8px}
    .completed{background:var(--green-row);border-color:#14532d}
    .items{font-size:14px;color:#cbd5e1;margin-top:6px}
    .pill{font-size:12px;margin-left:8px;color:#cbd5e1}
    .error{color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Amistades Belgas — Pedidos (Admin v3)</h1>
      <div class="muted">Orden por llegada (más viejo → más nuevo)</div>
    </header>

    <div class="card">
      <div class="toolbar">
        <div>
          <label>Modo</label>
          <select id="mode">
            <option value="live">En vivo (sin filtros)</option>
            <option value="today">Pedidos de hoy</option>
            <option value="thursday">Histórico (jueves)</option>
          </select>
        </div>
        <div>
          <label>Fecha (solo jueves)</label>
          <input id="dateInput" type="date" />
        </div>
        <div>
          <label>Orden</label>
          <select id="orderBy">
            <option value="arrival">Orden de llegada</option>
            <option value="name">Por nombre</option>
            <option value="total">Por total</option>
          </select>
        </div>
      </div>

      <div id="err" class="error"></div>
      <div id="list" class="list" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    // Firebase config (tus credenciales)
    const firebaseConfig = {
  apiKey: "AIzaSyBPNfGVvTJWEim3qgK3rS2PcEaqpej3Dms",
  authDomain: "barbelga-3f021.firebaseapp.com",
  projectId: "barbelga-3f021",
  storageBucket: "barbelga-3f021.firebasestorage.app",
  messagingSenderId: "111939067233",
  appId: "1:111939067233:web:6af08d6f96a22cb38c3920"
};
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, where, limit, updateDoc, doc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const modeSel = document.getElementById('mode');
    const dateInput = document.getElementById('dateInput');
    const orderSel = document.getElementById('orderBy');
    const listEl = document.getElementById('list');
    const errEl = document.getElementById('err');

    function pad2(n){ return n.toString().padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function nearestThursday(baseDate){
      const d = new Date(baseDate);
      const day = d.getDay(); // 0..6 (4=Thu)
      const diff = (day >= 4) ? day - 4 : (7 - (4 - day));
      d.setDate(d.getDate() - diff);
      return d;
    }
    function startEndOfDay(d){ return { start: new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0), end: new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999) }; }
    function parseCreatedAt(row){
      const v = row.createdAt;
      if(v && typeof v.toDate === 'function') return v.toDate();
      if(typeof v === 'string') return new Date(v);
      if(typeof v === 'number') return new Date(v);
      return null;
    }

    // Inicializa fecha a jueves más próximo
    const lastThu = nearestThursday(new Date());
    dateInput.value = ymd(lastThu);

    modeSel.addEventListener('change', run);
    orderSel.addEventListener('change', render);
    dateInput.addEventListener('change', run);

    let unsubscribe = null;
    let cache = [];

    function run(){
      if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      errEl.textContent = "";
      cache = [];

      const mode = modeSel.value;

      // Consulta mínima, como antes: ORDER BY createdAt DESC y luego ordenamos en cliente.
      // Esto evita problemas y garantiza datos frescos primero.
      let qRef;
      try{
        qRef = query(collection(db,'orders'), orderBy('createdAt','desc'), limit(200));
      }catch(e){
        // Fallback sin orderBy
        qRef = collection(db, 'orders');
      }

      unsubscribe = onSnapshot(qRef, (snap)=>{
        const rows = [];
        snap.forEach(d => rows.push({ id: d.id, ...d.data() }));

        // Filtro en cliente según modo
        if(mode === 'today' || mode === 'thursday'){
          const base = mode === 'today' ? new Date() : new Date(dateInput.value);
          const {start,end} = startEndOfDay(base);
          cache = rows.filter(r => {
            const dt = parseCreatedAt(r);
            return dt && dt >= start && dt <= end;
          });
        }else{
          cache = rows;
        }

        render();
      }, (err)=>{
        console.error(err);
        errEl.textContent = 'Error leyendo pedidos: ' + err.message;
      });
    }

    function render(){
      if(!cache.length){
        listEl.innerHTML = "<div class='muted'>No hay pedidos en este rango.</div>";
        return;
      }
      const by = orderSel.value;
      const rows = [...cache];

      if(by === 'arrival'){
        // ÚNICO requisito: orden de llegada → más viejo a más nuevo
        rows.sort((a,b)=> (parseCreatedAt(a)?.getTime()||0) - (parseCreatedAt(b)?.getTime()||0) );
      }else if(by === 'name'){
        rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      }else if(by === 'total'){
        rows.sort((a,b)=> (a.total||0) - (b.total||0));
      }

      listEl.innerHTML = "";
      rows.forEach(row=>{
        const d = document.createElement("details");
        const completed = row.status === "completed";
        d.style.background = completed ? "var(--green-row)" : "#0b1220";
        const time = parseCreatedAt(row)?.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || "--:--";
        const s = document.createElement("summary");
        s.innerHTML = `<div class="row">
          <div><strong>${row.name||"—"}</strong> <span class="pill">(${(row.items||[]).reduce((a,x)=>a+x.qty,0)} uds)</span></div>
          <div class="muted">${time}</div>
          <div>${new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(row.total||0)}</div>
          <div style="text-align:right"><span class="status ${completed?'completed':''}">${completed?'Completado':'Pendiente'}</span></div>
        </div>`;
        const content = document.createElement("div");
        content.className="items";
        content.innerHTML = (row.items||[]).map(it=>`• ${it.name} × ${it.qty}`).join("<br>") || "<em>Sin líneas</em>";
        const actions = document.createElement("div");
        actions.style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end";
        const btn = document.createElement("button");
        btn.textContent = completed ? "Marcar como pendiente" : "Completar";
        btn.className = completed ? "" : "btn-primary";
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          await updateDoc(doc(db,"orders",row.id), { status: completed ? "pending" : "completed", updatedAt: serverTimestamp(), completedAt: completed ? null : serverTimestamp() });
        });
        actions.appendChild(btn);
        d.appendChild(s); d.appendChild(content); d.appendChild(actions);
        listEl.appendChild(d);
      });
    }

    run();
  </script>
</body>
</html>
