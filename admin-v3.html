<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amistades Belgas — Admin v3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#ffffff;--card:#ffffff;--muted:#64748b;--text:#0b1220;--accent:#16a34a;--accent-600:#15803d;--shadow:0 10px 25px rgba(0,0,0,.08);--radius:18px;--green-row:rgba(34,197,94,.18);--border:#e2e8f0}
    .dark{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-600:#16a34a;--shadow:0 10px 25px rgba(0,0,0,.25);--radius:18px;--green-row:rgba(34,197,94,.12);--border:#1f2937}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif} .card{border:1px solid var(--border)}
    .container{max-width:1000px;margin:28px auto 56px;padding:0 16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{font-size:22px;margin:0} .muted{color:var(--muted);font-size:12px}
    .toolbar{display:grid;grid-template-columns: 1fr 260px 220px;gap:10px;align-items:end;margin:8px 0}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,button{padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--text)}
    button{cursor:pointer} .btn-primary{background:var(--accent);border-color:var(--accent-600);color:#052e16;font-weight:700}
    details{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:8px 12px;margin-bottom:8px}
    summary{display:flex;justify-content:space-between;align-items:center;cursor:pointer;list-style:none}
    summary::-webkit-details-marker{display:none}
    .row{display:grid;grid-template-columns: 1fr 120px 110px 110px;gap:6px;align-items:center}
    .status{font-size:12px;border:1px solid #334155;border-radius:999px;padding:2px 8px}
    .completed{background:var(--green-row);border-color:#14532d}
    .items{font-size:14px;color:#cbd5e1;margin-top:6px}
    .pill{font-size:12px;margin-left:8px;color:#cbd5e1}
    .stat{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 0}
    .stat > div{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:6px 10px;font-size:12px}
    .error{color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Amistades Belgas — Pedidos (Admin v3)</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Incluye modo "sin filtros" para depuración</div>
        <button id="themeBtn" style="background:transparent;border:1px solid var(--border);border-radius:12px;width:40px;height:40px;display:grid;place-items:center;cursor:pointer"><span id="themeIcon">🌙</span></button>
      </div>
    </header>


    <div class="card">
      <div class="toolbar">
        <div>
          <label>Modo</label>
          <select id="mode">
            <option value="live">En vivo (sin filtros)</option>
            <option value="today">Pedidos de hoy</option>
            <option value="thursday">Histórico (jueves)</option>
          </select>
        </div>
        <div>
          <label>Fecha (solo jueves)</label>
          <input id="dateInput" type="date" />
        </div>
        <div>
          <label>Orden</label>
          <select id="orderBy">
            <option value="createdAt">Por creación</option>
            <option value="name">Por nombre</option>
            <option value="total">Por total</option>
          </select>
        </div>
      </div>

      <div class="stat">
        <div id="statDocs">—</div>
        <div id="statMode">—</div>
        <div id="statError" class="error"></div>
      </div>

      <div id="list" class="list" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
  apiKey: "AIzaSyBPNfGVvTJWEim3qgK3rS2PcEaqpej3Dms",
  authDomain: "barbelga-3f021.firebaseapp.com",
  projectId: "barbelga-3f021",
  storageBucket: "barbelga-3f021.firebasestorage.app",
  messagingSenderId: "111939067233",
  appId: "1:111939067233:web:6af08d6f96a22cb38c3920"
};
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, where, limit, updateDoc, doc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Tema claro/oscuro
    const savedTheme = localStorage.getItem('ab_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.body.classList.toggle('dark', savedTheme==='dark');
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    function updateThemeIcon(){ themeIcon.textContent = document.body.classList.contains('dark') ? '🌙' : '☀️'; }
    updateThemeIcon();
    themeBtn.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); localStorage.setItem('ab_theme', document.body.classList.contains('dark') ? 'dark' : 'light'); updateThemeIcon(); });

    const modeSel = document.getElementById('mode');
    const dateInput = document.getElementById('dateInput');
    const orderSel = document.getElementById('orderBy');
    const listEl = document.getElementById('list');
    const statDocs = document.getElementById('statDocs');
    const statMode = document.getElementById('statMode');
    const statError = document.getElementById('statError');

    function pad2(n){ return n.toString().padStart(2,'0'); }
    function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function nearestThursday(baseDate){
      const d = new Date(baseDate);
      const day = d.getDay(); // 0..6 (4=Thu)
      const diff = (day >= 4) ? day - 4 : (7 - (4 - day));
      d.setDate(d.getDate() - diff);
      return d;
    }
    function startEndOfDay(d){
      return { start: new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0), end: new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999) };
    }
    function parseCreatedAt(row){
      const v = row.createdAt;
      if(v && typeof v.toDate === 'function') return v.toDate();
      if(typeof v === 'string') return new Date(v);
      if(typeof v === 'number') return new Date(v);
      return null;
    }
    function renderRows(rows){
      if(!rows.length){ listEl.innerHTML = "<div class='muted'>No hay pedidos para este modo.</div>"; return; }
      listEl.innerHTML = "";
      const by = orderSel.value;
      rows.sort((a,b)=>{
        const at = (parseCreatedAt(a)?.getTime()||0);
        const bt = (parseCreatedAt(b)?.getTime()||0);
        return at - bt; // más viejo -> más nuevo
      });
        if(by === "total") return (b.total||0) - (a.total||0);
        const at = parseCreatedAt(a)?.getTime() || 0; const bt = parseCreatedAt(b)?.getTime() || 0; return bt - at;
      });
      rows.forEach(row=>{
        const d = document.createElement("details");
        const completed = row.status === "completed";
        d.style.background = completed ? "var(--green-row)" : "#0b1220";
        const time = parseCreatedAt(row)?.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || "--:--";
        const s = document.createElement("summary");
        s.innerHTML = `<div class="row">
          <div><strong>${row.name||"—"}</strong> <span class="pill">(${(row.items||[]).reduce((a,x)=>a+x.qty,0)} uds)</span></div>
          <div class="muted">${time}</div>
          <div>${new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(row.total||0)}</div>
          <div style="text-align:right"><span class="status ${completed?'completed':''}">${completed?'Completado':'Pendiente'}</span></div>
        </div>`;
        const content = document.createElement("div");
        content.className="items";
        content.innerHTML = (row.items||[]).map(it=>`• ${it.name} × ${it.qty}`).join("<br>") || "<em>Sin líneas</em>";
        const actions = document.createElement("div");
        actions.style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end";
        const btn = document.createElement("button");
        btn.textContent = completed ? "Marcar como pendiente" : "Completar";
        btn.className = completed ? "" : "btn-primary";
        btn.addEventListener("click", async (e)=>{
          e.stopPropagation();
          await updateDoc(doc(db,"orders",row.id), { status: completed ? "pending" : "completed", updatedAt: serverTimestamp(), completedAt: completed ? null : serverTimestamp() });
        });
        actions.appendChild(btn);
        d.appendChild(s); d.appendChild(content); d.appendChild(actions);
        listEl.appendChild(d);
      });
    }

    let unsubscribe = null;
    function run(){
      statError.textContent = "";
      if(unsubscribe){ unsubscribe(); unsubscribe=null; }
      const mode = modeSel.value;
      statMode.textContent = `Modo: ${mode}`;

      if(mode === "live"){
        // Sin filtros: últimos 200 por createdAt desc (si existe), si no, por name.
        try{
          const qRef = query(collection(db,"orders"), orderBy("createdAt","desc"), limit(200));
          unsubscribe = onSnapshot(qRef,(snap)=>{
            const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
            statDocs.textContent = `Documentos recibidos: ${snap.size}`;
            renderRows(rows);
          }, err => statError.textContent = err.message);
        }catch(e){
          const qRef = collection(db,"orders");
          unsubscribe = onSnapshot(qRef,(snap)=>{
            const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
            statDocs.textContent = `Documentos recibidos (sin orden): ${snap.size}`;
            renderRows(rows);
          }, err => statError.textContent = err.message);
        }
        return;
      }

      if(mode === "today" || mode === "thursday"){
        const base = mode === "today" ? new Date() : new Date(dateInput.value);
        // Query amplia + filtro en cliente
        let qRef;
        try{
          qRef = query(collection(db,"orders"), orderBy("createdAt","desc"), limit(200));
        }catch(_){
          qRef = collection(db,"orders");
        }
        unsubscribe = onSnapshot(qRef,(snap)=>{
          const all=[]; snap.forEach(d=>all.push({id:d.id,...d.data()}));
          statDocs.textContent = `Documentos recibidos: ${snap.size}`;
          const {start,end} = startEndOfDay(base);
          const rows = all.filter(r=>{
            const dt = parseCreatedAt(r);
            return dt && dt>=start && dt<=end;
          });
          renderRows(rows);
        }, err => statError.textContent = err.message);
      }
    }

    // Init date input (jueves más cercano por comodidad)
    const lastThu = nearestThursday(new Date());
    document.getElementById('dateInput').value = ymd(lastThu);

    modeSel.addEventListener('change', run);
    orderSel.addEventListener('change', run);
    dateInput.addEventListener('change', run);

    run();
  </script>
</body>
</html>
