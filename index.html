<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amistades Belgas — Pedido de bebidas</title>
  <meta name="description" content="Frontend de pedidos de bebidas para Amistades Belgas" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#22c55e;    /* green-500 */
      --accent-600:#16a34a;/* green-600 */
      --danger:#ef4444;    /* red-500 */
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      background: radial-gradient(1200px 600px at 70% -20%, #1e293b 0%, transparent 70%), var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .container{max-width: 920px;margin: 28px auto 56px;padding: 0 16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom: 18px;}
    .brand{display:flex;align-items:center;gap:12px;}
    .badge{font-size:12px;padding:2px 8px;border:1px solid #334155;border-radius:999px;color:#cbd5e1;background:#0b1220;}
    .lang-select{margin-left:auto;background:#0b1220;color:var(--text);border:1px solid #334155;border-radius: 12px;padding:10px 12px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)), var(--card);border: 1px solid #1f2937;border-radius: var(--radius);box-shadow: var(--shadow);padding: 16px;}
    .toolbar{display:grid;grid-template-columns: 1fr 190px;gap:14px;align-items:end;margin-top:10px;}
    .toolbar .name-group label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .toolbar input[type="text"]{width:100%;padding: 12px 14px;border-radius: 12px;border:1px solid #334155;background:#0b1220;color:var(--text);outline:none;}
    .toolbar input[type="text"]::placeholder{color:#64748b}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top: 12px;}
    .th, .td{text-align:left;padding: 10px 12px;font-size: 15px;}
    .th{color:#cbd5e1;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:.04em;}
    .row{background:#0b1220;border:1px solid #1f2937;border-radius: 12px;}
    .qty{display:flex;align-items:center;gap:10px;justify-content:flex-end;}
    .btn{appearance:none;border:none;padding:10px 12px;border-radius:12px;cursor:pointer;background:#0f172a;color:var(--text);border:1px solid #1f2937;transition:.15s transform ease;}
    .btn:active{transform:translateY(1px)}
    .btn-icon{width:36px;height:36px;display:grid;place-items:center;font-weight:700}
    .btn-ghost{background:transparent;border-color:#334155}
    .btn-primary{background:var(--accent);border-color:var(--accent-600);color:#052e16;font-weight:700}
    .btn-danger{background:transparent;border-color:#ef4444;color:#fecaca}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top: 6px;padding-top: 8px;}
    .total{font-size: 22px;font-weight:800;letter-spacing:.02em;}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns: 1fr 80px 140px;gap:10px;align-items:center;}
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr 80px 120px} .toolbar{grid-template-columns:1fr} .lang-select{position:fixed;top:10px;right:10px; z-index:10} header{padding-right:70px} }
    .toast{position:fixed;right:12px;top:12px;background:#0b1220;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow)}
  </style>
</head>

  <button id="test-push">Probar notificación</button>

<script>
  const VAPID_PUBLIC_KEY = BGnW3Z0RvUafeqinWTlLwX9su68fnzOSMz565kY1sJRDYfBKlvI-ZsqwD67JWXKxV_z4UekFSzPa3i4FuYdnoNI; // <-- tu clave pública
  const WORKER_PUSH_URL = "https://withered-bird-4c02.kligman-nicolas.workers.dev/push"; // <-- tu worker

  // Utilidad: base64url -> Uint8Array
  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const raw = atob(base64);
    const output = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
    return output;
  }

  async function setupPush() {
    if (!("serviceWorker" in navigator)) {
      alert("Tu navegador no soporta Service Workers.");
      return;
    }
    if (!("PushManager" in window)) {
      alert("Tu navegador no soporta Web Push.");
      return;
    }

    // Importante en GitHub Pages:
    // Usa 'sw.js' (sin barra inicial) para que tome el scope del repositorio.
    const reg = await navigator.serviceWorker.register("sw.js");

    // Pide permiso de notificaciones
    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("Permiso de notificaciones denegado.");
      return;
    }

    // Crea suscripción con tu VAPID PUBLIC KEY
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
    });

    // Envía la suscripción a tu Worker para disparar un push de prueba
    const res = await fetch(WORKER_PUSH_URL, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ subscription: sub }),
    });
    const data = await res.json().catch(() => ({}));
    console.log("Respuesta Worker:", data);
    if (data.ok) {
      alert("Push enviado. Revisa la notificación del sistema.");
    } else {
      alert("No se pudo enviar el push: " + (data.error || res.status));
    }
  }

  document.getElementById("test-push").addEventListener("click", () => {
    setupPush().catch(err => {
      console.error(err);
      alert("Error: " + err.message);
    });
  });
</script>


  
<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2l3 6 6 .9-4.5 4.2 1.1 6.5L12 16.9 6.4 19.6 7.6 13 3 8.9 9 8l3-6z" stroke="#22c55e" fill="none"/>
        </svg>
        <div>
          <div style="font-weight:800; letter-spacing:.02em">Amistades Belgas</div>
          <div class="badge">Pedidos</div>
        </div>
      </div>
      <select class="lang-select" id="langSelect" aria-label="Idioma">
        <option value="es">ES</option>
        <option value="fr">FR</option>
        <option value="nl">NL</option>
        <option value="en">EN</option>
      </select>
    </header>

    <div class="card">
      <div class="toolbar">
        <div class="name-group">
          <label id="nameLabel" for="nameInput">Tu nombre</label>
          <input id="nameInput" type="text" placeholder="Escribe tu nombre…" required>
        </div>
        <div style="text-align:right">
          <div class="muted" id="todayHint"></div>
        </div>
      </div>

      <table class="table" role="table" aria-label="Lista de bebidas">
        <thead>
          <tr class="grid th">
            <th id="thDrink" class="th">Bebida</th>
            <th id="thPrice" class="th" style="text-align:right">Precio</th>
            <th id="thQty" class="th" style="text-align:right">Cantidad</th>
          </tr>
        </thead>
        <tbody id="items"></tbody>
      </table>

      <div class="footer">
        <div class="muted" id="validationMsg"></div>
        <div class="total"><span id="totalLabel">Total</span>: <span id="totalAmount">€0.00</span></div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px">
        <button id="clearBtn" class="btn btn-danger">Borrar pedido</button>
        <button id="submitBtn" class="btn btn-primary">Enviar pedido</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ---- Language/i18n -----------------------------------------------------
    const I18N = {
      es: { nameLabel:"Tu nombre", namePlaceholder:"Escribe tu nombre…", drink:"Bebida", price:"Precio", qty:"Cantidad", total:"Total", clear:"Borrar pedido", send:"Enviar pedido", requiredName:"El nombre es obligatorio.", emptyOrder:"Selecciona al menos una bebida.", sent:"¡Pedido enviado!", error:"Error al enviar el pedido." },
      en: { nameLabel:"Your name", namePlaceholder:"Type your name…", drink:"Drink", price:"Price", qty:"Qty", total:"Total", clear:"Clear order", send:"Send order", requiredName:"Name is required.", emptyOrder:"Pick at least one drink.", sent:"Order sent!", error:"Failed to send order." },
      fr: { nameLabel:"Votre prénom", namePlaceholder:"Écrivez votre prénom…", drink:"Boisson", price:"Prix", qty:"Qté", total:"Total", clear:"Effacer la commande", send:"Envoyer la commande", requiredName:"Le prénom est obligatoire.", emptyOrder:"Choisissez au moins une boisson.", sent:"Commande envoyée !", error:"Échec de l'envoi de la commande." },
      nl: { nameLabel:"Je naam", namePlaceholder:"Vul je naam in…", drink:"Drank", price:"Prijs", qty:"Aantal", total:"Totaal", clear:"Bestelling wissen", send:"Bestelling verzenden", requiredName:"Naam is verplicht.", emptyOrder:"Kies minstens één drankje.", sent:"Bestelling verzonden!", error:"Verzenden mislukt." }
    };

    function detectLocale(){
      const saved = localStorage.getItem("ab_lang");
      if(saved) return saved;
      const nav = (navigator.language || "es").toLowerCase();
      if(nav.startsWith("nl")) return "nl";
      if(nav.startsWith("fr")) return "fr";
      if(nav.startsWith("en")) return "en";
      return "es";
    }
    let locale = detectLocale();
    const langSelect = document.getElementById("langSelect");
    langSelect.value = locale;
    langSelect.addEventListener("change", () => { locale = langSelect.value; localStorage.setItem("ab_lang", locale); ensureMessagingToken(app);
    render(); });

    // ---- Data con traducciones --------------------------------------------
    const DRINKS = [
      { id:"agua_sin_gas", price:1.00, name:{es:"Agua sin gas", en:"Still water", fr:"Eau plate", nl:"Plat water"} },
      { id:"agua_con_gas", price:1.00, name:{es:"Agua con gas", en:"Sparkling water", fr:"Eau gazeuse", nl:"Bruiswater"} },
      { id:"coca_cola", price:1.50, name:{es:"Coca Cola", en:"Coca‑Cola", fr:"Coca‑Cola", nl:"Coca‑Cola"} },
      { id:"coca_cola_zero", price:1.50, name:{es:"Coca Cola Zero", en:"Coca‑Cola Zero", fr:"Coca‑Cola Zéro", nl:"Coca‑Cola Zero"} },
      { id:"fanta_naranja", price:1.50, name:{es:"Fanta Naranja", en:"Fanta Orange", fr:"Fanta Orange", nl:"Fanta Sinaas"} },
      { id:"fanta_limon", price:1.50, name:{es:"Fanta Limón", en:"Fanta Lemon", fr:"Fanta Citron", nl:"Fanta Citroen"} },
      { id:"nestea", price:1.50, name:{es:"Nestea", en:"Nestea", fr:"Nestea", nl:"Nestea"} },
      { id:"tonica", price:1.50, name:{es:"Tónica", en:"Tonic", fr:"Tonic", nl:"Tonic"} },
      { id:"bitter_kas", price:1.50, name:{es:"Bitter Kas", en:"Bitter Kas", fr:"Bitter Kas", nl:"Bitter Kas"} },
      { id:"cerveza", price:1.50, name:{es:"Cerveza", en:"Beer", fr:"Bière", nl:"Bier"} },
      { id:"cerveza_sin_alcohol", price:1.50, name:{es:"Cerveza Sin Alcohol", en:"Alcohol‑free beer", fr:"Bière sans alcool", nl:"Alcoholvrij bier"} },
      { id:"leffe_bl", price:2.50, name:{es:"Leffe rubia", en:"Leffe Blond", fr:"Leffe Blonde", nl:"Leffe Blond"} },
      { id:"duvel", price:2.50, name:{es:"Duvel", en:"Duvel", fr:"Duvel", nl:"Duvel"} },
      { id:"omer", price:2.50, name:{es:"Omer", en:"Omer", fr:"Omer", nl:"Omer"} },
      { id:"chimay_blauw", price:3.00, name:{es:"Chimay Azul", en:"Chimay Blue", fr:"Chimay Bleue", nl:"Chimay Blauw"} },
      { id:"kriek", price:2.50, name:{es:"Kriek", en:"Kriek", fr:"Kriek", nl:"Kriek"} },
      { id:"vino_tinto", price:7.50, name:{es:"Vino Tinto (copa)", en:"Red wine (glass)", fr:"Vin rouge (verre)", nl:"Rode wijn (glas)"} },
      { id:"vino_blanco", price:7.50, name:{es:"Vino blanco (copa)", en:"White wine (glass)", fr:"Vin blanc (verre)", nl:"Witte wijn (glas)"} },
      { id:"vino_rosado", price:7.00, name:{es:"Vino Rosado (copa)", en:"Rosé wine (glass)", fr:"Vin rosé (verre)", nl:"Rosé (glas)"} },
      { id:"botella_vino", price:9.00, name:{es:"Botella vino", en:"Bottle of wine", fr:"Bouteille de vin", nl:"Fles wijn"} },
      { id:"cava_pequeno", price:2.50, name:{es:"Cava pequeño", en:"Cava small", fr:"Cava petit", nl:"Cava klein"} },
      { id:"cava_grande", price:11.00, name:{es:"Cava Grande", en:"Cava large", fr:"Cava grand", nl:"Cava groot"} },
      { id:"whisky", price:2.50, name:{es:"Whisky", en:"Whisky", fr:"Whisky", nl:"Whisky"} },
      { id:"cognac", price:2.50, name:{es:"Cognac", en:"Cognac", fr:"Cognac", nl:"Cognac"} },
      { id:"gin", price:2.50, name:{es:"Gin", en:"Gin", fr:"Gin", nl:"Gin"} },
      { id:"vodka", price:2.50, name:{es:"Vodka", en:"Vodka", fr:"Vodka", nl:"Vodka"} },
      { id:"cafe", price:1.50, name:{es:"Café", en:"Coffee", fr:"Café", nl:"Koffie"} },
      { id:"te", price:1.50, name:{es:"Té", en:"Tea", fr:"Thé", nl:"Thee"} },
      { id:"chupito", price:1.00, name:{es:"Chupito", en:"Shot", fr:"Shooter", nl:"Shotje"} },
    ];
    const state = { name: "", quantities: Object.fromEntries(DRINKS.map(d => [d.id, 0])) };

    const fmt = (value) => new Intl.NumberFormat(
      locale === "nl" ? "nl-NL" : locale === "fr" ? "fr-FR" : locale === "en" ? "en-GB" : "es-ES",
      { style: "currency", currency: "EUR" }
    ).format(value);
    const todayHint = () => { const d = new Date(); const weekday = d.toLocaleDateString(locale, { weekday: 'long' }); return `${weekday}, ${d.toLocaleDateString(locale)}`; };
    function total(){ return DRINKS.reduce((acc, d) => acc + (state.quantities[d.id] || 0) * d.price, 0); }
    function hasAnyQty(){ return Object.values(state.quantities).some(v => v > 0); }
    const getName = (d) => d.name[locale] || d.name.es;

    function render(){
      const t = I18N[locale];
      document.getElementById("nameLabel").textContent = t.nameLabel;
      document.getElementById("nameInput").placeholder = t.namePlaceholder;
      document.getElementById("thDrink").textContent = t.drink;
      document.getElementById("thPrice").textContent = t.price;
      document.getElementById("thQty").textContent = t.qty;
      document.getElementById("totalLabel").textContent = t.total;
      document.getElementById("clearBtn").textContent = t.clear;
      document.getElementById("submitBtn").textContent = t.send;
      document.getElementById("todayHint").textContent = todayHint();

      const tbody = document.getElementById("items");
      tbody.innerHTML = "";
      DRINKS.forEach(d => {
        const tr = document.createElement("tr");
        tr.className = "grid row";
        tr.innerHTML = `
          <td class="td">${getName(d)}</td>
          <td class="td" style="text-align:right">${fmt(d.price)}</td>
          <td class="td" style="text-align:right">
            <div class="qty">
              <button class="btn btn-icon btn-ghost" aria-label="menos" data-action="decr" data-id="${d.id}">−</button>
              <div style="min-width:20px; text-align:center" aria-live="polite">${state.quantities[d.id] || 0}</div>
              <button class="btn btn-icon" aria-label="más" data-action="incr" data-id="${d.id}">+</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          const action = e.currentTarget.getAttribute("data-action");
          const current = state.quantities[id] || 0;
          let next = action === "incr" ? current + 1 : Math.max(0, current - 1);
          state.quantities[id] = next;
          ensureMessagingToken(app);
    render();
        });
      });

      document.getElementById("totalAmount").textContent = fmt(total());
      validate();
    }

    function validate(){
      const t = I18N[locale];
      const msgEl = document.getElementById("validationMsg");
      let msg = "";
      if(!state.name.trim()) msg = t.requiredName;
      else if(!hasAnyQty()) msg = t.emptyOrder;
      msgEl.textContent = msg;
      document.getElementById("submitBtn").disabled = !!msg;
    }

    const nameInput = document.getElementById("nameInput");
    nameInput.addEventListener("input", (e)=>{ state.name = e.target.value; validate(); });
    const savedName = localStorage.getItem("ab_name");
    if(savedName){ state.name = savedName; nameInput.value = savedName; }

    document.getElementById("clearBtn").addEventListener("click", () => { for(const k in state.quantities) state.quantities[k] = 0; ensureMessagingToken(app);
    render(); });

    // ---- Firebase (Firestore + Messaging) ---------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyBPNfGVvTJWEim3qgK3rS2PcEaqpej3Dms",
  authDomain: "barbelga-3f021.firebaseapp.com",
  projectId: "barbelga-3f021",
  storageBucket: "barbelga-3f021.firebasestorage.app",
  messagingSenderId: "111939067233",
  appId: "1:111939067233:web:6af08d6f96a22cb38c3920"
};
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Messaging (cliente) ---
    const WORKER_SEND_URL = "https://TU-WORKER.workers.dev/send"; // Cambia por tu Worker real
    const VAPID_PUBLIC_KEY = "TU_VAPID_PUBLIC_KEY"; // Firebase Console → Cloud Messaging → Web Push certificates
    let clientToken = localStorage.getItem('ab_client_token') || null;

    async function ensureMessagingToken(app) {
      try {
        if (!(await isSupported())) return null;
        // Registrar service worker (debe existir a la par de index.html)
        const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
        const messaging = getMessaging(app);
        const token = await getToken(messaging, { vapidKey: VAPID_PUBLIC_KEY, serviceWorkerRegistration: reg });
        if (token) {
          localStorage.setItem('ab_client_token', token);
          clientToken = token;
        }
        // Mensajes en foreground
        onMessage(messaging, (payload) => {
          if (payload?.notification?.title) {
            toast(payload.notification.title + (payload.notification.body ? ' — ' + payload.notification.body : ''));
          }
        });
        return token;
      } catch (e) {
        console.warn('Messaging no disponible o permiso denegado:', e);
        return null;
      }
    }

    function toast(text){ let t = document.createElement("div"); t.className="toast"; t.textContent = text; document.body.appendChild(t); setTimeout(()=>t.remove(), 2500); }

    async function sendOrder(){
      const t = I18N[locale];
      const items = DRINKS.map(d => ({ id: d.id, name: getName(d), price: d.price, qty: state.quantities[d.id] || 0 })).filter(x => x.qty > 0);
      const payload = { name: state.name.trim(), items, total: total(), status: \"pending\", clientToken: clientToken || null };
      try{
        await addDoc(collection(db, "orders"), { ...payload, createdAt: serverTimestamp() });
        // Notificar a admins (opcional, si registraron token en admin)
        try {
          const snap = await getDocs(collection(db, "adminTokens"));
          const tokens = [];
          snap.forEach(d => tokens.push(d.id));
          if(tokens.length){
            await fetch(WORKER_SEND_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tokens,
                notification: { title: "🧾 Nuevo pedido", body: payload.name + " — " + new Intl.NumberFormat('es-ES',{style:'currency','currency':'EUR'}).format(payload.total) }
              })
            });
          }
        } catch(e){ console.warn("No se pudo notificar a admins:", e); }
        localStorage.setItem("ab_name", payload.name); toast(t.sent);
        for(const k in state.quantities) state.quantities[k] = 0; ensureMessagingToken(app);
    render();
      }catch(err){ console.error(err); toast(t.error); }
    }
    document.getElementById("submitBtn").addEventListener("click", sendOrder);

    ensureMessagingToken(app);
    render();
  </script>
</body>
</html>
